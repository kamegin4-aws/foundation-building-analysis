AWSTemplateFormatVersion: 2010-09-09
Metadata:
  'AWS::CloudFormation::Designer':
    350108e5-ca85-47f8-8d29-9a2ad77fceeb:
      size:
        width: 1500
        height: 830
      position:
        x: -380
        'y': 110
      z: 0
      embeds:
        - 12feec27-08b7-49bb-ad2e-c5d91794edff
        - f880c388-26e5-45ed-bd6d-0f6b15d7b464
        - 5a43d249-4eb3-4135-88e1-a6cd6265ee48
        - f81eefea-d3c2-4fc6-8452-9fc5338f6a65
        - 180e2ee1-8578-4629-b20b-4cd47d57f011
        - c43c019d-9ffe-43b3-ae02-d60b4d4bc5d6
        - c9011329-7e1f-43cc-aa61-c2c8f7682cb5
        - 0b70d9bd-f468-4ad8-a76b-0ed9cbc9bc95
        - 748cf0da-74e5-43eb-92dd-97b3337f3831
        - c172b2b4-1e18-46f4-a9ac-e5feefb27c6d
        - e616c472-8719-4b09-ade8-958721f4dbfa
        - 98527b75-4047-4ee1-8c9d-f73ea82e84fd
        - b905d21b-a08c-489f-88d5-c1668033a80e
        - 3d63d8d7-768c-4598-a3f7-3dffdbc00411
        - 9384b3df-130b-4b04-8107-2ea01180adfb
        - 4703e375-3d3c-4cc5-b7ff-fd132e5bc879
        - 09adaace-5635-4afd-a037-758ca6091634
        - 858329c2-e110-4f9a-819e-41d58272fe7c
        - ac9c17dc-48e6-4001-abf5-767138f4c670
        - 5ce5b250-2492-454f-8629-1aa84e7be81e
        - a6a6320c-95bb-4b75-ad09-804ea053ed8c
        - 25d3c3f7-5a53-4737-b2dc-20466b4528da
        - 66f7b881-80b6-4a5b-8ecf-6427532dcc24
        - c9b4d4ee-cfb4-4913-a8b1-6b079f2de24a
        - c7875a33-6903-4ddb-b14c-970ff5ef58f5
        - ed43b443-0134-463d-92fa-97721a39eb33
    e616c472-8719-4b09-ade8-958721f4dbfa:
      size:
        width: 130
        height: 130
      position:
        x: 260
        'y': 340
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    c172b2b4-1e18-46f4-a9ac-e5feefb27c6d:
      size:
        width: 140
        height: 140
      position:
        x: 260
        'y': 520
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    748cf0da-74e5-43eb-92dd-97b3337f3831:
      size:
        width: 170
        height: 150
      position:
        x: 340
        'y': 160
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds:
        - 877df7de-303d-41b0-8cde-715149eb0973
    c9011329-7e1f-43cc-aa61-c2c8f7682cb5:
      size:
        width: 180
        height: 140
      position:
        x: 340
        'y': 720
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    877df7de-303d-41b0-8cde-715149eb0973:
      size:
        width: 60
        height: 60
      position:
        x: 400
        'y': 210
      z: 2
      parent: 748cf0da-74e5-43eb-92dd-97b3337f3831
      embeds: []
      dependson:
        - d309ea03-35dc-459a-aea8-5ad31f794575
    ac9c17dc-48e6-4001-abf5-767138f4c670:
      size:
        width: 60
        height: 60
      position:
        x: 830
        'y': 270
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    c9b4d4ee-cfb4-4913-a8b1-6b079f2de24a:
      size:
        width: 60
        height: 60
      position:
        x: 900
        'y': 330
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    c43c019d-9ffe-43b3-ae02-d60b4d4bc5d6:
      size:
        width: 60
        height: 60
      position:
        x: 670
        'y': 160
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    d77346db-2158-49fd-a44a-cf19413170ab:
      size:
        width: 60
        height: 60
      position:
        x: -550
        'y': 360
      z: 0
      embeds: []
    d309ea03-35dc-459a-aea8-5ad31f794575:
      source:
        id: d77346db-2158-49fd-a44a-cf19413170ab
      target:
        id: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      z: 0
    ae7edc86-2097-4a67-95b3-ed5b0c95017a:
      size:
        width: 60
        height: 60
      position:
        x: -550
        'y': 260
      z: 0
      embeds: []
    9384b3df-130b-4b04-8107-2ea01180adfb:
      size:
        width: 60
        height: 60
      position:
        x: 740
        'y': 720
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    4703e375-3d3c-4cc5-b7ff-fd132e5bc879:
      size:
        width: 60
        height: 60
      position:
        x: -340
        'y': 430
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    09adaace-5635-4afd-a037-758ca6091634:
      size:
        width: 60
        height: 60
      position:
        x: -240
        'y': 390
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    858329c2-e110-4f9a-819e-41d58272fe7c:
      size:
        width: 60
        height: 60
      position:
        x: -240
        'y': 480
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
      dependson:
        - ae7edc86-2097-4a67-95b3-ed5b0c95017a
    180e2ee1-8578-4629-b20b-4cd47d57f011:
      size:
        width: 130
        height: 126.62577069354427
      position:
        x: 460
        'y': 350
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    3d63d8d7-768c-4598-a3f7-3dffdbc00411:
      size:
        width: 60
        height: 60
      position:
        x: 660
        'y': 670
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    98527b75-4047-4ee1-8c9d-f73ea82e84fd:
      size:
        width: 60
        height: 60
      position:
        x: 980
        'y': 400
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    f81eefea-d3c2-4fc6-8452-9fc5338f6a65:
      size:
        width: 140
        height: 140
      position:
        x: 450
        'y': 520
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    ed43b443-0134-463d-92fa-97721a39eb33:
      size:
        width: 60
        height: 60
      position:
        x: 760
        'y': 560
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    c7875a33-6903-4ddb-b14c-970ff5ef58f5:
      size:
        width: 60
        height: 60
      position:
        x: 670
        'y': 520
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    5a43d249-4eb3-4135-88e1-a6cd6265ee48:
      size:
        width: 60
        height: 60
      position:
        x: -150
        'y': 430
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    4646c1b8-02ba-409a-bdfc-31f6a1f6d621:
      source:
        id: c7875a33-6903-4ddb-b14c-970ff5ef58f5
      target:
        id: c7875a33-6903-4ddb-b14c-970ff5ef58f5
      z: 1
    0b70d9bd-f468-4ad8-a76b-0ed9cbc9bc95:
      size:
        width: 60
        height: 60
      position:
        x: 820
        'y': 770
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    b905d21b-a08c-489f-88d5-c1668033a80e:
      size:
        width: 60
        height: 60
      position:
        x: 890
        'y': 820
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    a6a6320c-95bb-4b75-ad09-804ea053ed8c:
      size:
        width: 60
        height: 60
      position:
        x: -60
        'y': 430
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    66f7b881-80b6-4a5b-8ecf-6427532dcc24:
      size:
        width: 60
        height: 60
      position:
        x: 40
        'y': 400
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    f880c388-26e5-45ed-bd6d-0f6b15d7b464:
      size:
        width: 60
        height: 60
      position:
        x: 140
        'y': 400
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    25d3c3f7-5a53-4737-b2dc-20466b4528da:
      size:
        width: 60
        height: 60
      position:
        x: 40
        'y': 480
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    12feec27-08b7-49bb-ad2e-c5d91794edff:
      size:
        width: 60
        height: 60
      position:
        x: 140
        'y': 480
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    5ce5b250-2492-454f-8629-1aa84e7be81e:
      size:
        width: 60
        height: 60
      position:
        x: 740
        'y': 230
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
Resources:
  VPC:
    Type: 'AWS::EC2::VPC'
    Properties:
      EnableDnsSupport: 'true'
      EnableDnsHostnames: 'true'
      CidrBlock: 10.0.0.0/16
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
  PublicSubnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: ap-northeast-1a
      MapPublicIpOnLaunch: true
    Metadata:
      'AWS::CloudFormation::Designer':
        id: e616c472-8719-4b09-ade8-958721f4dbfa
  PrivateSubnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: ap-northeast-1a
    Metadata:
      'AWS::CloudFormation::Designer':
        id: c172b2b4-1e18-46f4-a9ac-e5feefb27c6d
  PublicRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 748cf0da-74e5-43eb-92dd-97b3337f3831
  PrivateRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: c9011329-7e1f-43cc-aa61-c2c8f7682cb5
  PublicRoute:
    Type: 'AWS::EC2::Route'
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      RouteTableId: !Ref PublicRouteTable
      GatewayId: !Ref InternetGateway
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 877df7de-303d-41b0-8cde-715149eb0973
    DependsOn:
      - VPCGatewayAttachment
  PublicSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Allow access from load balancer and SSH traffic
      SecurityGroupIngress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          SourceSecurityGroupId: !Ref ExternalLoadBalancerSecurityGroup
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt VPC.CidrBlock
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt PublicSubnet.CidrBlock
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt PublicSubnet2.CidrBlock
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref globalIP
      SecurityGroupEgress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: 0.0.0.0/0
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: ac9c17dc-48e6-4001-abf5-767138f4c670
  PrivateSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Allow access from public subnet and SSH traffic
      SecurityGroupIngress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          SourceSecurityGroupId: !Ref PublicSecurityGroup
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt VPC.CidrBlock
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt PrivateSubnet.CidrBlock
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt PrivateSubnet2.CidrBlock
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref globalIP
      SecurityGroupEgress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: 0.0.0.0/0
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: c9b4d4ee-cfb4-4913-a8b1-6b079f2de24a
  ExternalLoadBalancerSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Allow HTTP(s) from anywhere
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: 0.0.0.0/0
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: c43c019d-9ffe-43b3-ae02-d60b4d4bc5d6
  InternetGateway:
    Type: 'AWS::EC2::InternetGateway'
    Properties: {}
    Metadata:
      'AWS::CloudFormation::Designer':
        id: d77346db-2158-49fd-a44a-cf19413170ab
  VPCGatewayAttachment:
    Type: 'AWS::EC2::VPCGatewayAttachment'
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: d309ea03-35dc-459a-aea8-5ad31f794575
  DNS:
    Type: 'AWS::Route53::RecordSetGroup'
    Properties:
      HostedZoneName: !Ref hostedZoneName
      Comment: Zone apex alias targeted to ExternalLoadBalancer.
      RecordSets:
        - Name: !Ref aName
          Type: A
          AliasTarget:
            HostedZoneId: !GetAtt ExternalLoadBalancer.CanonicalHostedZoneID
            DNSName: !GetAtt ExternalLoadBalancer.DNSName
    Metadata:
      'AWS::CloudFormation::Designer':
        id: ae7edc86-2097-4a67-95b3-ed5b0c95017a
  ExternalLoadBalancer:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      Name: !Sub '${AWS::StackName}-exlb'
      Scheme: internet-facing
      SecurityGroups:
        - !Ref ExternalLoadBalancerSecurityGroup
      Subnets:
        - !Ref PublicSubnet
        - !Ref PublicSubnet2
      Type: application
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 4703e375-3d3c-4cc5-b7ff-fd132e5bc879
  HTTPListener:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - Type: forward
          ForwardConfig:
            TargetGroups:
              - TargetGroupArn: !GetAtt WebTargetGroup.TargetGroupArn
                Weight: 1
      LoadBalancerArn: !GetAtt ExternalLoadBalancer.LoadBalancerArn
      Port: 80
      Protocol: HTTP
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 09adaace-5635-4afd-a037-758ca6091634
  HTTPSListener:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - Type: forward
          ForwardConfig:
            TargetGroups:
              - TargetGroupArn: !GetAtt WebTargetGroup.TargetGroupArn
                Weight: 1
      LoadBalancerArn: !GetAtt ExternalLoadBalancer.LoadBalancerArn
      Certificates:
        - CertificateArn: !Ref certificateArn
      Port: 443
      Protocol: HTTPS
      SslPolicy: ELBSecurityPolicy-2016-08
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 858329c2-e110-4f9a-819e-41d58272fe7c
    DependsOn:
      - DNS
  PublicSubnet2:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: ap-northeast-1c
      MapPublicIpOnLaunch: true
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 180e2ee1-8578-4629-b20b-4cd47d57f011
  CloudWatchLogsVPCEndpoint:
    Type: 'AWS::EC2::VPCEndpoint'
    Properties:
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.logs'
      VpcId: !Ref VPC
      SubnetIds:
        - !Ref PrivateSubnet
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 9384b3df-130b-4b04-8107-2ea01180adfb
  SecretsManagerVPCEndpoint:
    Type: 'AWS::EC2::VPCEndpoint'
    Properties:
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.secretsmanager'
      VpcId: !Ref VPC
      SubnetIds:
        - !Ref PrivateSubnet
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 3d63d8d7-768c-4598-a3f7-3dffdbc00411
  VPCEndpointSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Allow access from VPC and Subnet
      SecurityGroupIngress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt VPC.CidrBlock
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt PublicSubnet.CidrBlock
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt PublicSubnet2.CidrBlock
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt PrivateSubnet.CidrBlock
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt PrivateSubnet2.CidrBlock
      SecurityGroupEgress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: 0.0.0.0/0
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 98527b75-4047-4ee1-8c9d-f73ea82e84fd
  PublicRouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable
  PublicRouteTableAssociation2:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable
  PrivateRouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PrivateSubnet
      RouteTableId: !Ref PrivateRouteTable
  PrivateRouteTableAssociation2:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable
  PrivateSubnet2:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.4.0/24
      AvailabilityZone: ap-northeast-1c
    Metadata:
      'AWS::CloudFormation::Designer':
        id: f81eefea-d3c2-4fc6-8452-9fc5338f6a65
  ElastiCacheSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Allow access from public and private
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 6379
          ToPort: 6379
          SourceSecurityGroupId: !Ref PublicSecurityGroup
        - IpProtocol: tcp
          FromPort: 6379
          ToPort: 6379
          SourceSecurityGroupId: !Ref PrivateSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: 0.0.0.0/0
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: ed43b443-0134-463d-92fa-97721a39eb33
  RDSSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Allow access from public and private
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref PublicSecurityGroup
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref PrivateSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: 0.0.0.0/0
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: c7875a33-6903-4ddb-b14c-970ff5ef58f5
  SelfRefSecurityGroupIgress:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      GroupId: !GetAtt RDSSecurityGroup.GroupId
      IpProtocol: tcp
      FromPort: 0
      ToPort: 65535
      SourceSecurityGroupId: !GetAtt RDSSecurityGroup.GroupId
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 4646c1b8-02ba-409a-bdfc-31f6a1f6d621
  WebTargetGroup:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 35
      HealthCheckPath: /
      HealthCheckPort: '80'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 30
      HealthyThresholdCount: 5
      Name: !Sub '${AWS::StackName}-webtg'
      Port: 80
      Protocol: HTTP
      TargetType: ip
      UnhealthyThresholdCount: 2
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 5a43d249-4eb3-4135-88e1-a6cd6265ee48
  S3VPCGatewayEndpoint:
    Type: 'AWS::EC2::VPCEndpoint'
    Properties:
      VpcEndpointType: Gateway
      VpcId: !Ref VPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.s3'
      RouteTableIds:
        - !Ref PrivateRouteTable
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 0b70d9bd-f468-4ad8-a76b-0ed9cbc9bc95
  RDSVPCEndpoint:
    Type: 'AWS::EC2::VPCEndpoint'
    Properties:
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.rds'
      VpcId: !Ref VPC
      SubnetIds:
        - !Ref PrivateSubnet
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
    Metadata:
      'AWS::CloudFormation::Designer':
        id: b905d21b-a08c-489f-88d5-c1668033a80e
  InternalLoadBalancer:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      Name: !Sub '${AWS::StackName}-inlb'
      Scheme: internal
      SecurityGroups:
        - !Ref InternalLoadBalancerSecurityGroup
      Subnets:
        - !Ref PublicSubnet
        - !Ref PublicSubnet2
      Type: network
    Metadata:
      'AWS::CloudFormation::Designer':
        id: a6a6320c-95bb-4b75-ad09-804ea053ed8c
  PresentationListener:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - Type: forward
          ForwardConfig:
            TargetGroups:
              - TargetGroupArn: !GetAtt PresentationTargetGroup.TargetGroupArn
      LoadBalancerArn: !GetAtt InternalLoadBalancer.LoadBalancerArn
      Port: 8080
      Protocol: TCP
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 66f7b881-80b6-4a5b-8ecf-6427532dcc24
  PresentationTargetGroup:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 35
      HealthCheckPath: /
      HealthCheckPort: '8080'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 30
      HealthyThresholdCount: 5
      Name: !Sub '${AWS::StackName}-pretg'
      Port: 8080
      Protocol: TCP
      TargetType: ip
      UnhealthyThresholdCount: 2
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: f880c388-26e5-45ed-bd6d-0f6b15d7b464
  ApplicationListener:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - Type: forward
          ForwardConfig:
            TargetGroups:
              - TargetGroupArn: !GetAtt ApplicationTargetGroup.TargetGroupArn
      LoadBalancerArn: !GetAtt InternalLoadBalancer.LoadBalancerArn
      Port: 8081
      Protocol: TCP
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 25d3c3f7-5a53-4737-b2dc-20466b4528da
  ApplicationTargetGroup:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 35
      HealthCheckPath: /health/
      HealthCheckPort: '8081'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 30
      HealthyThresholdCount: 5
      Name: !Sub '${AWS::StackName}-apptg'
      Port: 8081
      Protocol: TCP
      TargetType: ip
      UnhealthyThresholdCount: 2
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 12feec27-08b7-49bb-ad2e-c5d91794edff
  InternalLoadBalancerSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Allow access from Public
      SecurityGroupIngress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          SourceSecurityGroupId: !Ref PublicSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: 0.0.0.0/0
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 5ce5b250-2492-454f-8629-1aa84e7be81e
Parameters:
  globalIP:
    Description: ' The IP address range that can be used to access the web server using SSH.'
    Type: String
    MinLength: '9'
    MaxLength: '18'
    Default: 0.0.0.0/32
    AllowedPattern: '(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})'
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
  hostedZoneName:
    Description: Host Zone(Route53)
    Type: String
    Default: XXXXXX.com.
  aName:
    Description: A NAME(ELB)
    Type: String
    Default: foundation-building.XXXX.com.
  certificateArn:
    Description: CertificateArn(ACM)
    Type: String
    Default: 'arn:aws:acm:ap-northeast-1:XXXXXXXXX:certificate/XXXX'
Outputs:
  AppDomain:
    Value: !GetAtt InternalLoadBalancer.DNSName
    Description: InternalLoadBalancer.DNSName
    Export:
      Name: appDomain
  VPCId:
    Value: !GetAtt VPC.VpcId
    Description: VPC.VpcId
    Export:
      Name: vpcId
  ELBWebTargetGroupArn:
    Value: !GetAtt WebTargetGroup.TargetGroupArn
    Description: WebTargetGroup.TargetGroupArn
    Export:
      Name: elbWebTargetGroupArn
  ELBPresentationTargetGroupArn:
    Value: !GetAtt PresentationTargetGroup.TargetGroupArn
    Description: PresentationTargetGroup.TargetGroupArn
    Export:
      Name: elbPresentationTargetGroupArn
  ELBApplicationTargetGroupArn:
    Value: !GetAtt ApplicationTargetGroup.TargetGroupArn
    Description: ApplicationTargetGroup.TargetGroupArn
    Export:
      Name: elbApplicationTargetGroupArn
  PublicSubnet1Id:
    Value: !GetAtt PublicSubnet.SubnetId
    Description: PublicSubnet.SubnetId
    Export:
      Name: publicSubnet1Id
  PublicSubnet2Id:
    Value: !GetAtt PublicSubnet2.SubnetId
    Description: PublicSubnet2.SubnetId
    Export:
      Name: publicSubnet2Id
  PrivateSubnet1Id:
    Value: !GetAtt PrivateSubnet.SubnetId
    Description: PrivateSubnet.SubnetId
    Export:
      Name: privateSubnet1Id
  PrivateSubnet2Id:
    Value: !GetAtt PrivateSubnet2.SubnetId
    Description: PrivateSubnet2.SubnetId
    Export:
      Name: privateSubnet2Id
  PublicSecurityGroupId:
    Value: !GetAtt PublicSecurityGroup.GroupId
    Description: PublicSecurityGroup.GroupId
    Export:
      Name: publicSecurityGroupId
  ElastiCacheSecurityGroupId:
    Value: !GetAtt ElastiCacheSecurityGroup.GroupId
    Description: ElastiCacheSecurityGroup.GroupId
    Export:
      Name: elastiCacheSecurityGroupId
  RDSSecurityGroupId:
    Value: !GetAtt RDSSecurityGroup.GroupId
    Description: RDSSecurityGroup.GroupId
    Export:
      Name: rdsSecurityGroupId
  InternalELBSecurityGroupId:
    Value: !GetAtt InternalLoadBalancerSecurityGroup.GroupId
    Description: InternalLoadBalancerSecurityGroup.GroupId
    Export:
      Name: internalELBSecurityGroupId
  VPCCidrBlock:
    Value: !GetAtt VPC.CidrBlock
    Description: VPC.CidrBlock
    Export:
      Name: vpcCidrBlock
  PublicSubnet1CidrBlock:
    Value: !GetAtt PublicSubnet.CidrBlock
    Description: PublicSubnet.CidrBlock
    Export:
      Name: publicSubnet1CidrBlock
  PublicSubnet2CidrBlock:
    Value: !GetAtt PublicSubnet2.CidrBlock
    Description: PublicSubnet2.CidrBlock
    Export:
      Name: publicSubnet2CidrBlock

