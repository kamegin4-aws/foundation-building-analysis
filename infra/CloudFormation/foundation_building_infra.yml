AWSTemplateFormatVersion: 2010-09-09
Metadata:
  'AWS::CloudFormation::Designer':
    350108e5-ca85-47f8-8d29-9a2ad77fceeb:
      size:
        width: 1310
        height: 650
      position:
        x: 280
        'y': 190
      z: 0
      embeds:
        - f81eefea-d3c2-4fc6-8452-9fc5338f6a65
        - 180e2ee1-8578-4629-b20b-4cd47d57f011
        - c43c019d-9ffe-43b3-ae02-d60b4d4bc5d6
        - c9011329-7e1f-43cc-aa61-c2c8f7682cb5
        - 0b70d9bd-f468-4ad8-a76b-0ed9cbc9bc95
        - 748cf0da-74e5-43eb-92dd-97b3337f3831
        - c172b2b4-1e18-46f4-a9ac-e5feefb27c6d
        - e616c472-8719-4b09-ade8-958721f4dbfa
        - 98527b75-4047-4ee1-8c9d-f73ea82e84fd
        - b905d21b-a08c-489f-88d5-c1668033a80e
        - a79a369e-e52e-4461-81b8-85a7a5a292f3
        - 3d63d8d7-768c-4598-a3f7-3dffdbc00411
        - 9384b3df-130b-4b04-8107-2ea01180adfb
        - ac9c17dc-48e6-4001-abf5-767138f4c670
        - 5ce5b250-2492-454f-8629-1aa84e7be81e
        - c9b4d4ee-cfb4-4913-a8b1-6b079f2de24a
        - c7875a33-6903-4ddb-b14c-970ff5ef58f5
        - ed43b443-0134-463d-92fa-97721a39eb33
    e616c472-8719-4b09-ade8-958721f4dbfa:
      size:
        width: 430
        height: 410
      position:
        x: 320
        'y': 220
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds:
        - 12feec27-08b7-49bb-ad2e-c5d91794edff
        - f880c388-26e5-45ed-bd6d-0f6b15d7b464
        - 5a43d249-4eb3-4135-88e1-a6cd6265ee48
        - 4703e375-3d3c-4cc5-b7ff-fd132e5bc879
        - 858329c2-e110-4f9a-819e-41d58272fe7c
        - 09adaace-5635-4afd-a037-758ca6091634
        - a6a6320c-95bb-4b75-ad09-804ea053ed8c
        - 25d3c3f7-5a53-4737-b2dc-20466b4528da
        - 66f7b881-80b6-4a5b-8ecf-6427532dcc24
    c172b2b4-1e18-46f4-a9ac-e5feefb27c6d:
      size:
        width: 140
        height: 140
      position:
        x: 760
        'y': 240
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    748cf0da-74e5-43eb-92dd-97b3337f3831:
      size:
        width: 170
        height: 150
      position:
        x: 920
        'y': 240
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds:
        - 877df7de-303d-41b0-8cde-715149eb0973
    c9011329-7e1f-43cc-aa61-c2c8f7682cb5:
      size:
        width: 180
        height: 140
      position:
        x: 920
        'y': 480
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    877df7de-303d-41b0-8cde-715149eb0973:
      size:
        width: 60
        height: 60
      position:
        x: 980
        'y': 290
      z: 2
      parent: 748cf0da-74e5-43eb-92dd-97b3337f3831
      embeds: []
      dependson:
        - d309ea03-35dc-459a-aea8-5ad31f794575
    ac9c17dc-48e6-4001-abf5-767138f4c670:
      size:
        width: 60
        height: 60
      position:
        x: 1160
        'y': 230
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    c9b4d4ee-cfb4-4913-a8b1-6b079f2de24a:
      size:
        width: 60
        height: 60
      position:
        x: 1170
        'y': 330
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    c43c019d-9ffe-43b3-ae02-d60b4d4bc5d6:
      size:
        width: 60
        height: 60
      position:
        x: 1380
        'y': 220
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    d77346db-2158-49fd-a44a-cf19413170ab:
      size:
        width: 60
        height: 60
      position:
        x: 100
        'y': 350
      z: 0
      embeds: []
    d309ea03-35dc-459a-aea8-5ad31f794575:
      source:
        id: d77346db-2158-49fd-a44a-cf19413170ab
      target:
        id: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      z: 0
    ae7edc86-2097-4a67-95b3-ed5b0c95017a:
      size:
        width: 60
        height: 60
      position:
        x: 100
        'y': 250
      z: 0
      embeds: []
    9384b3df-130b-4b04-8107-2ea01180adfb:
      size:
        width: 60
        height: 60
      position:
        x: 1260
        'y': 630
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    4703e375-3d3c-4cc5-b7ff-fd132e5bc879:
      size:
        width: 60
        height: 60
      position:
        x: 340
        'y': 250
      z: 2
      parent: e616c472-8719-4b09-ade8-958721f4dbfa
      embeds: []
    09adaace-5635-4afd-a037-758ca6091634:
      size:
        width: 60
        height: 60
      position:
        x: 570
        'y': 230
      z: 2
      parent: e616c472-8719-4b09-ade8-958721f4dbfa
      embeds: []
    858329c2-e110-4f9a-819e-41d58272fe7c:
      size:
        width: 60
        height: 60
      position:
        x: 650
        'y': 230
      z: 2
      parent: e616c472-8719-4b09-ade8-958721f4dbfa
      embeds: []
      dependson:
        - ae7edc86-2097-4a67-95b3-ed5b0c95017a
    180e2ee1-8578-4629-b20b-4cd47d57f011:
      size:
        width: 130
        height: 126.62577069354427
      position:
        x: 350
        'y': 700
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    3d63d8d7-768c-4598-a3f7-3dffdbc00411:
      size:
        width: 60
        height: 60
      position:
        x: 1490
        'y': 520
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    98527b75-4047-4ee1-8c9d-f73ea82e84fd:
      size:
        width: 60
        height: 60
      position:
        x: 1500
        'y': 230
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    f81eefea-d3c2-4fc6-8452-9fc5338f6a65:
      size:
        width: 140
        height: 140
      position:
        x: 640
        'y': 680
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    ed43b443-0134-463d-92fa-97721a39eb33:
      size:
        width: 60
        height: 60
      position:
        x: 1370
        'y': 480
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    c7875a33-6903-4ddb-b14c-970ff5ef58f5:
      size:
        width: 60
        height: 60
      position:
        x: 1206.651829918721
        'y': 500.0696468059381
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    bd476613-5374-4df3-a7c5-06e03a5e509a:
      size:
        width: 60
        height: 60
      position:
        x: 200
        'y': 110
      z: 0
      embeds: []
    9675c918-4365-4b04-a9ef-1090d3f06346:
      size:
        width: 60
        height: 60
      position:
        x: 110
        'y': 170
      z: 0
      embeds: []
    5a43d249-4eb3-4135-88e1-a6cd6265ee48:
      size:
        width: 60
        height: 60
      position:
        x: 450
        'y': 300
      z: 2
      parent: e616c472-8719-4b09-ade8-958721f4dbfa
      embeds: []
    a79a369e-e52e-4461-81b8-85a7a5a292f3:
      size:
        width: 60
        height: 60
      position:
        x: 1350
        'y': 590
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    4646c1b8-02ba-409a-bdfc-31f6a1f6d621:
      source:
        id: c7875a33-6903-4ddb-b14c-970ff5ef58f5
      target:
        id: c7875a33-6903-4ddb-b14c-970ff5ef58f5
      z: 1
    0b70d9bd-f468-4ad8-a76b-0ed9cbc9bc95:
      size:
        width: 60
        height: 60
      position:
        x: 1480
        'y': 620
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    b905d21b-a08c-489f-88d5-c1668033a80e:
      size:
        width: 60
        height: 60
      position:
        x: 1360
        'y': 680
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
    a6a6320c-95bb-4b75-ad09-804ea053ed8c:
      size:
        width: 60
        height: 60
      position:
        x: 340
        'y': 520
      z: 2
      parent: e616c472-8719-4b09-ade8-958721f4dbfa
      embeds: []
    66f7b881-80b6-4a5b-8ecf-6427532dcc24:
      size:
        width: 60
        height: 60
      position:
        x: 570
        'y': 400
      z: 2
      parent: e616c472-8719-4b09-ade8-958721f4dbfa
      embeds: []
    f880c388-26e5-45ed-bd6d-0f6b15d7b464:
      size:
        width: 60
        height: 60
      position:
        x: 440
        'y': 450
      z: 2
      parent: e616c472-8719-4b09-ade8-958721f4dbfa
      embeds: []
    25d3c3f7-5a53-4737-b2dc-20466b4528da:
      size:
        width: 60
        height: 60
      position:
        x: 660
        'y': 390
      z: 2
      parent: e616c472-8719-4b09-ade8-958721f4dbfa
      embeds: []
    12feec27-08b7-49bb-ad2e-c5d91794edff:
      size:
        width: 60
        height: 60
      position:
        x: 440
        'y': 530
      z: 2
      parent: e616c472-8719-4b09-ade8-958721f4dbfa
      embeds: []
    5ce5b250-2492-454f-8629-1aa84e7be81e:
      size:
        width: 60
        height: 60
      position:
        x: 1270
        'y': 280
      z: 1
      parent: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
      embeds: []
Resources:
  VPC:
    Type: 'AWS::EC2::VPC'
    Properties:
      EnableDnsSupport: 'true'
      EnableDnsHostnames: 'true'
      CidrBlock: 10.0.0.0/16
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 350108e5-ca85-47f8-8d29-9a2ad77fceeb
  PublicSubnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: ap-northeast-1a
      MapPublicIpOnLaunch: true
    Metadata:
      'AWS::CloudFormation::Designer':
        id: e616c472-8719-4b09-ade8-958721f4dbfa
  PrivateSubnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: ap-northeast-1a
    Metadata:
      'AWS::CloudFormation::Designer':
        id: c172b2b4-1e18-46f4-a9ac-e5feefb27c6d
  PublicRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 748cf0da-74e5-43eb-92dd-97b3337f3831
  PrivateRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: c9011329-7e1f-43cc-aa61-c2c8f7682cb5
  PublicRoute:
    Type: 'AWS::EC2::Route'
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      RouteTableId: !Ref PublicRouteTable
      GatewayId: !Ref InternetGateway
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 877df7de-303d-41b0-8cde-715149eb0973
    DependsOn:
      - VPCGatewayAttachment
  PublicSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Allow access from load balancer and SSH traffic
      SecurityGroupIngress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          SourceSecurityGroupId: !Ref ExternalLoadBalancerSecurityGroup
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt VPC.CidrBlock
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt PublicSubnet.CidrBlock
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt PublicSubnet2.CidrBlock
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref SSHLocation
      SecurityGroupEgress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: 0.0.0.0/0
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: ac9c17dc-48e6-4001-abf5-767138f4c670
  PrivateSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Allow access from public subnet and SSH traffic
      SecurityGroupIngress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          SourceSecurityGroupId: !Ref PublicSecurityGroup
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt VPC.CidrBlock
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt PrivateSubnet.CidrBlock
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt PrivateSubnet2.CidrBlock
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref SSHLocation
      SecurityGroupEgress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: 0.0.0.0/0
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: c9b4d4ee-cfb4-4913-a8b1-6b079f2de24a
  ExternalLoadBalancerSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Allow HTTP(s) and app from anywhere
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: 0.0.0.0/0
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: c43c019d-9ffe-43b3-ae02-d60b4d4bc5d6
  InternetGateway:
    Type: 'AWS::EC2::InternetGateway'
    Properties: {}
    Metadata:
      'AWS::CloudFormation::Designer':
        id: d77346db-2158-49fd-a44a-cf19413170ab
  VPCGatewayAttachment:
    Type: 'AWS::EC2::VPCGatewayAttachment'
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: d309ea03-35dc-459a-aea8-5ad31f794575
  DNS:
    Type: 'AWS::Route53::RecordSetGroup'
    Properties:
      HostedZoneName: !Ref HostedZoneName
      Comment: Zone apex alias targeted to ExternalLoadBalancer.
      RecordSets:
        - Name: !Ref AName
          Type: A
          AliasTarget:
            HostedZoneId: !GetAtt ExternalLoadBalancer.CanonicalHostedZoneID
            DNSName: !GetAtt ExternalLoadBalancer.DNSName
    Metadata:
      'AWS::CloudFormation::Designer':
        id: ae7edc86-2097-4a67-95b3-ed5b0c95017a
  ExternalLoadBalancer:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      Name: ExternalLoadBalancer
      Scheme: internet-facing
      SecurityGroups:
        - !Ref ExternalLoadBalancerSecurityGroup
      Subnets:
        - !Ref PublicSubnet
        - !Ref PublicSubnet2
      Type: application
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 4703e375-3d3c-4cc5-b7ff-fd132e5bc879
  ExternalELBHTTPListener:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - Type: forward
          ForwardConfig:
            TargetGroups:
              - TargetGroupArn: !GetAtt WebTargetGroup.TargetGroupArn
                Weight: 1
            TargetGroupStickinessConfig:
              DurationSeconds: 3600
              Enabled: true
      LoadBalancerArn: !GetAtt ExternalLoadBalancer.LoadBalancerArn
      Port: 80
      Protocol: HTTP
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 09adaace-5635-4afd-a037-758ca6091634
  ExternalELBHTTPSListener:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - Type: forward
          ForwardConfig:
            TargetGroups:
              - TargetGroupArn: !GetAtt WebTargetGroup.TargetGroupArn
                Weight: 1
            TargetGroupStickinessConfig:
              DurationSeconds: 3600
              Enabled: true
      LoadBalancerArn: !GetAtt ExternalLoadBalancer.LoadBalancerArn
      Certificates:
        - CertificateArn: !Ref CertificateArn
      Port: 443
      Protocol: HTTPS
      SslPolicy: ELBSecurityPolicy-2016-08
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 858329c2-e110-4f9a-819e-41d58272fe7c
    DependsOn: []
  PublicSubnet2:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: ap-northeast-1c
      MapPublicIpOnLaunch: true
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 180e2ee1-8578-4629-b20b-4cd47d57f011
  VPCLogsEndpoint:
    Type: 'AWS::EC2::VPCEndpoint'
    Properties:
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.logs'
      VpcId: !Ref VPC
      SubnetIds:
        - !Ref PrivateSubnet
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 9384b3df-130b-4b04-8107-2ea01180adfb
  VPCASMEndpoint:
    Type: 'AWS::EC2::VPCEndpoint'
    Properties:
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.secretsmanager'
      VpcId: !Ref VPC
      SubnetIds:
        - !Ref PrivateSubnet
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 3d63d8d7-768c-4598-a3f7-3dffdbc00411
  VPCEndpointSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Allow access from VPC and Subnet
      SecurityGroupIngress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt VPC.CidrBlock
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt PublicSubnet.CidrBlock
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt PublicSubnet2.CidrBlock
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt PrivateSubnet.CidrBlock
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: !GetAtt PrivateSubnet2.CidrBlock
      SecurityGroupEgress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: 0.0.0.0/0
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 98527b75-4047-4ee1-8c9d-f73ea82e84fd
  PublicRouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable
  PublicRouteTableAssociation2:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable
  PrivateRouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PrivateSubnet
      RouteTableId: !Ref PrivateRouteTable
  PrivateRouteTableAssociation2:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable
  PrivateSubnet2:
    Type: 'AWS::EC2::Subnet'
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.4.0/24
      AvailabilityZone: ap-northeast-1c
    Metadata:
      'AWS::CloudFormation::Designer':
        id: f81eefea-d3c2-4fc6-8452-9fc5338f6a65
  ElastiCacheSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Allow access from public and private
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 11211
          ToPort: 11211
          SourceSecurityGroupId: !Ref PublicSecurityGroup
        - IpProtocol: tcp
          FromPort: 11211
          ToPort: 11211
          SourceSecurityGroupId: !Ref PrivateSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: 0.0.0.0/0
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: ed43b443-0134-463d-92fa-97721a39eb33
  RDSSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Allow access from public and private
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref PublicSecurityGroup
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref PrivateSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: 0.0.0.0/0
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: c7875a33-6903-4ddb-b14c-970ff5ef58f5
  SelfRefSecurityGroupIgress:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      GroupId: !GetAtt RDSSecurityGroup.GroupId
      IpProtocol: tcp
      FromPort: 0
      ToPort: 65535
      SourceSecurityGroupId: !GetAtt RDSSecurityGroup.GroupId
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 4646c1b8-02ba-409a-bdfc-31f6a1f6d621
  GlobalWebACL:
    Type: 'AWS::WAFv2::WebACL'
    Properties:
      DefaultAction:
        Allow: {}
      Scope: REGIONAL
      VisibilityConfig:
        MetricName: GlobalWebACLMetric
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
      Rules:
        - Name: AWS-AWSManagedRulesAmazonIpReputationList
          Priority: 0
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesAmazonIpReputationList
          OverrideAction:
            None: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: AWS-AWSManagedRulesAmazonIpReputationList
        - Name: AWS-AWSManagedRulesCommonRuleSet
          Priority: 1
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesCommonRuleSet
          OverrideAction:
            None: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: AWS-AWSManagedRulesCommonRuleSet
        - Name: AWS-AWSManagedRulesKnownBadInputsRuleSet
          Priority: 2
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesKnownBadInputsRuleSet
          OverrideAction:
            None: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: AWS-AWSManagedRulesKnownBadInputsRuleSet
    Metadata:
      'AWS::CloudFormation::Designer':
        id: bd476613-5374-4df3-a7c5-06e03a5e509a
  GlobalWebACLAssociation:
    Type: 'AWS::WAFv2::WebACLAssociation'
    Properties:
      WebACLArn: !GetAtt GlobalWebACL.Arn
      ResourceArn: !Ref ExternalLoadBalancer
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 9675c918-4365-4b04-a9ef-1090d3f06346
  WebTargetGroup:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 35
      HealthCheckPath: /
      HealthCheckPort: '80'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 30
      HealthyThresholdCount: 5
      Name: WebTargetGroup
      Port: 80
      Protocol: HTTP
      TargetType: ip
      UnhealthyThresholdCount: 2
      VpcId: !Ref VPC
      TargetGroupAttributes:
        - Key: stickiness.enabled
          Value: 'true'
        - Key: stickiness.type
          Value: lb_cookie
        - Key: stickiness.lb_cookie.duration_seconds
          Value: '3600'
        - Key: deregistration_delay.timeout_seconds
          Value: '300'
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 5a43d249-4eb3-4135-88e1-a6cd6265ee48
  VPCS3GatewayEndpoint:
    Type: 'AWS::EC2::VPCEndpoint'
    Properties:
      VpcEndpointType: Gateway
      VpcId: !Ref VPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.s3'
      RouteTableIds:
        - !Ref PrivateRouteTable
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 0b70d9bd-f468-4ad8-a76b-0ed9cbc9bc95
  VPCS3InterfaceEndpoint:
    Type: 'AWS::EC2::VPCEndpoint'
    Properties:
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.s3'
      VpcId: !Ref VPC
      SubnetIds:
        - !Ref PrivateSubnet
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
    Metadata:
      'AWS::CloudFormation::Designer':
        id: a79a369e-e52e-4461-81b8-85a7a5a292f3
  VPCRDSEndpoint:
    Type: 'AWS::EC2::VPCEndpoint'
    Properties:
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.rds'
      VpcId: !Ref VPC
      SubnetIds:
        - !Ref PrivateSubnet
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
    Metadata:
      'AWS::CloudFormation::Designer':
        id: b905d21b-a08c-489f-88d5-c1668033a80e
  InternalLoadBalancer:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      Name: InternalLoadBalancer
      Scheme: internal
      SecurityGroups:
        - !Ref InternalLoadBalancerSecurityGroup
      Subnets:
        - !Ref PublicSubnet
        - !Ref PublicSubnet2
      Type: network
    Metadata:
      'AWS::CloudFormation::Designer':
        id: a6a6320c-95bb-4b75-ad09-804ea053ed8c
  InternalELBPresentationListener:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - Type: forward
          ForwardConfig:
            TargetGroups:
              - TargetGroupArn: !GetAtt PresentationTargetGroup.TargetGroupArn
      LoadBalancerArn: !GetAtt InternalLoadBalancer.LoadBalancerArn
      Port: 8080
      Protocol: TCP
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 66f7b881-80b6-4a5b-8ecf-6427532dcc24
  PresentationTargetGroup:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 35
      HealthCheckPath: /
      HealthCheckPort: '8080'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 30
      HealthyThresholdCount: 5
      Name: PresentationTargetGroup
      Port: 8080
      Protocol: TCP
      TargetType: ip
      UnhealthyThresholdCount: 2
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: f880c388-26e5-45ed-bd6d-0f6b15d7b464
  InternalELBApplicationListener:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - Type: forward
          ForwardConfig:
            TargetGroups:
              - TargetGroupArn: !GetAtt ApplicationTargetGroup.TargetGroupArn
      LoadBalancerArn: !GetAtt InternalLoadBalancer.LoadBalancerArn
      Port: 8081
      Protocol: TCP
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 25d3c3f7-5a53-4737-b2dc-20466b4528da
  ApplicationTargetGroup:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 35
      HealthCheckPath: /
      HealthCheckPort: '8081'
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 30
      HealthyThresholdCount: 5
      Name: ApplicationTargetGroup
      Port: 8081
      Protocol: TCP
      TargetType: ip
      UnhealthyThresholdCount: 2
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 12feec27-08b7-49bb-ad2e-c5d91794edff
  InternalLoadBalancerSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Allow access from Public
      SecurityGroupIngress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          SourceSecurityGroupId: !Ref PublicSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: '-1'
          FromPort: -1
          ToPort: -1
          CidrIp: 0.0.0.0/0
      VpcId: !Ref VPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 5ce5b250-2492-454f-8629-1aa84e7be81e
Parameters:
  SSHLocation:
    Description: ' The IP address range that can be used to access the web server using SSH.'
    Type: String
    MinLength: '9'
    MaxLength: '18'
    Default: 0.0.0.0/32
    AllowedPattern: '(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})'
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
  HostedZoneName:
    Description: Host Zone(Route53)
    Type: String
    Default: XXXXXX.com.
  AName:
    Description: A NAME(ELB)
    Type: String
    Default: foundation-building.XXXX.com.
  CertificateArn:
    Description: CertificateArn(ACM)
    Type: String
    Default: 'arn:aws:acm:ap-northeast-1:XXXXXXXXX:certificate/XXXX'
Outputs:
  AppDomain:
    Value: !GetAtt InternalLoadBalancer.DNSName
    Description: InternalLoadBalancer.DNSName
  VPCId:
    Value: !GetAtt VPC.VpcId
    Description: VPC.VpcId
  ELBWebTargetGroupArn:
    Value: !GetAtt WebTargetGroup.TargetGroupArn
    Description: WebTargetGroup.TargetGroupArn
  ELBPresentationTargetGroupArn:
    Value: !GetAtt PresentationTargetGroup.TargetGroupArn
    Description: PresentationTargetGroup.TargetGroupArn
  ELBApplicationTargetGroupArn:
    Value: !GetAtt ApplicationTargetGroup.TargetGroupArn
    Description: ApplicationTargetGroup.TargetGroupArn
  PublicSubnet1Id:
    Value: !GetAtt PublicSubnet.SubnetId
    Description: PublicSubnet.SubnetId
  PublicSubnet2Id:
    Value: !GetAtt PublicSubnet2.SubnetId
    Description: PublicSubnet2.SubnetId
  PrivateSubnet1Id:
    Value: !GetAtt PrivateSubnet.SubnetId
    Description: PrivateSubnet.SubnetId
  PrivateSubnet2Id:
    Value: !GetAtt PrivateSubnet2.SubnetId
    Description: PrivateSubnet2.SubnetId
  PublicSecurityGroupId:
    Value: !GetAtt PublicSecurityGroup.GroupId
    Description: PublicSecurityGroup.GroupId
  ElastiCacheSecurityGroupId:
    Value: !GetAtt ElastiCacheSecurityGroup.GroupId
    Description: ElastiCacheSecurityGroup.GroupId
  RDSSecurityGroupId:
    Value: !GetAtt RDSSecurityGroup.GroupId
    Description: RDSSecurityGroup.GroupId
  InternalELBSecurityGroupId:
    Value: !GetAtt InternalLoadBalancerSecurityGroup.GroupId
    Description: InternalLoadBalancerSecurityGroup.GroupId
